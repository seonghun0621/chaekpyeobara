# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1uhzqdVLIgx-RNuF9vtIOqQr0crUY1g7W
"""

import streamlit as st
import requests
import re
import json
from datetime import datetime

# ì•Œë¼ë”˜ API ì¸ì¦í‚¤ (ì—¬ê¸°ì— ìì‹ ì˜ TTBKeyë¥¼ ì…ë ¥)
TTB_KEY = "ttbtmdwn021442001"

# ì±… ê²€ìƒ‰ í•¨ìˆ˜
def search_book(book_title):
    search_url = "http://www.aladin.co.kr/ttb/api/ItemSearch.aspx"
    params = {
        "ttbkey": TTB_KEY,
        "Query": book_title,
        "QueryType": "Title",
        "MaxResults": 1,
        "SearchTarget": "Book",
        "output": "js",
        "Version": "20131101"
    }
    response = requests.get(search_url, params=params)
    data = response.json()

    if "item" in data and len(data["item"]) > 0:
        book = data["item"][0]
        book_info = {
            "title": book.get("title", "ì œëª© ì •ë³´ ì—†ìŒ"),
            "author": book.get("author", "ì €ì ì •ë³´ ì—†ìŒ"),
            "publisher": book.get("publisher", "ì¶œíŒì‚¬ ì •ë³´ ì—†ìŒ"),
            "price": book.get("priceStandard", "ê°€ê²© ì •ë³´ ì—†ìŒ"),
            "isbn": book.get("isbn13", None)
        }

        if book_info["isbn"]:
            lookup_url = "http://www.aladin.co.kr/ttb/api/ItemLookUp.aspx"
            lookup_params = {
                "ttbkey": TTB_KEY,
                "itemIdType": "ISBN",
                "ItemId": book_info["isbn"],
                "output": "js",
                "Version": "20131101"
            }
            lookup_response = requests.get(lookup_url, params=lookup_params)
            lookup_data = lookup_response.json()

            if "item" in lookup_data and len(lookup_data["item"]) > 0:
                details = lookup_data["item"][0]
                book_info["page_count"] = details.get("subInfo", {}).get("itemPage", "ìª½ìˆ˜ ì •ë³´ ì—†ìŒ")
            else:
                book_info["page_count"] = "ìª½ìˆ˜ ì •ë³´ ì—†ìŒ"
        else:
            book_info["page_count"] = "ìª½ìˆ˜ ì •ë³´ ì—†ìŒ"

        return book_info
    else:
        return {"error": "ì±… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."}

# ëª©í‘œ ì½ê¸° ê³„íš ìƒì„± í•¨ìˆ˜
def calculate_daily_pages(total_pages, target_days):
    try:
        daily_pages = total_pages // target_days
        remaining_pages = total_pages % target_days
        return daily_pages, remaining_pages
    except ZeroDivisionError:
        return 0, 0

# ëª©í‘œë¥¼ ì¬ì¡°ì •í•˜ëŠ” í•¨ìˆ˜
def recalculate_goal_dynamic(remaining_pages, pages_read_today, remaining_days):
    remaining_pages -= pages_read_today
    if remaining_pages <= 0:
        return remaining_pages, 0, 0, "ì±…ì„ ë‹¤ ì½ì—ˆì–´ìš”!"
    
    new_daily_goal = remaining_pages // remaining_days
    remaining_days -= 1
    
    return remaining_pages, new_daily_goal, remaining_days, f"ë‚¨ì€ ëª©í‘œ ì¼ìˆ˜ëŠ” {remaining_days}ì¼ì´ì—ìš”."

# ëª©í‘œ ì •ë³´ ì €ì¥ í•¨ìˆ˜
def save_goal(book_title, target_days, daily_pages, remaining_pages):
    goal_data = {
        "book_title": book_title,
        "target_days": target_days,
        "daily_pages": daily_pages,
        "remaining_pages": remaining_pages,
        "date_completed": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    try:
        # íŒŒì¼ì— ì €ì¥
        with open("reading_goals.json", "a", encoding="utf-8") as file:
            json.dump(goal_data, file, ensure_ascii=False, indent=4)
            file.write("\n")
        st.write("ğŸ“‚ ëª©í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë‹¤ìŒì— ì´ ëª©í‘œë¥¼ ë‹¤ì‹œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!")
    except Exception as e:
        st.write(f"ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

# ëª©í‘œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
def load_goals():
    try:
        with open("reading_goals.json", "r", encoding="utf-8") as file:
            goals = file.readlines()
            return [json.loads(goal) for goal in goals]
    except Exception as e:
        st.write(f"ëª©í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return []

# ë„ì „ ê³¼ì œ ì œê³µ
def give_challenge(book_title):
    st.write(f"ğŸ¯ **{book_title}** ì±…ì„ ë‹¤ ì½ì€ ê²ƒì„ ì¶•í•˜ë“œë ¤ìš”! ğŸ¦¦")
    st.write("ìƒˆë¡œìš´ ë„ì „ ê³¼ì œë¥¼ ì œê³µí•©ë‹ˆë‹¤! ë‹¤ìŒ ì±…ë„ ì½ì–´ë³´ì„¸ìš”! ğŸ“š")
    # ì˜ˆì‹œ ë„ì „ ê³¼ì œ ì œê³µ
    st.write("1. **ë‘ ë²ˆì§¸ ì±…**ì„ 3ì¼ ì•ˆì— ì½ê¸°!")
    st.write("2. **ì½ì€ ì±… ê¸°ë¡ ë‚¨ê¸°ê¸°** - ì±…ì˜ ê°ìƒë¬¸ì„ ì‘ì„±í•˜ê³  ê³µìœ í•´ë³´ì„¸ìš”!")
    st.write("ë‹¤ìŒ ë„ì „ì€ ë¬´ì—‡ì¸ê°€ìš”? ë‹¤ì‹œ ëª©í‘œë¥¼ ì„¤ì •í•´ë³¼ê¹Œìš”? ğŸ¾")

# Streamlit ë ˆì´ì•„ì›ƒ ì„¤ì •
st.set_page_config(page_title="ì±…í´ë°”ë¼ - ìˆ²ì† ë„ì„œê´€", layout="wide")
st.title("ì±…í´ë°”ë¼ ìˆ²ì† ë„ì„œê´€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ¦¦ğŸ“š")

# í…ìŠ¤íŠ¸ì™€ ìƒ‰ìƒ ì„¤ì •
st.markdown("""
    <style>
        body {
            background-color: #aaf0d1;  # ì—°ë‘ìƒ‰ ë°°ê²½
            color: #87cefa;  # í•˜ëŠ˜ìƒ‰ í…ìŠ¤íŠ¸
        }
        .sidebar .sidebar-content {
            background-color: #aaf0d1;
        }
        .stButton>button {
            background-color: #87cefa;
            color: white;
            border-radius: 10px;
            padding: 10px;
        }
    </style>
    """, unsafe_allow_html=True)

# ì‚¬ìš©ì ì…ë ¥ì„ ë°›ê¸°
book_title = st.text_input("ê²€ìƒ‰í•  ì±… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:")

if book_title:
    book_info = search_book(book_title)

    if "error" not in book_info:
        st.write(f"ìš°ì›…~ ğŸ¦¦ ì œê°€ ì°¾ì•„ë´¤ëŠ”ë°ìš”!")
        st.write(f"ì±… ì´ë¦„ì€ **'{book_info['title']}'**ì´ê³ ìš”,")
        st.write(f"ì§€ì€ì´ëŠ” **{book_info['author']}**ë‹˜, ì¶œíŒì‚¬ëŠ” **{book_info['publisher']}**ëë‹ˆë‹¤! ğŸ¾")
        st.write(f"ê°€ê²©ì€ **{book_info['price']}ì›**ì´ì—ìš”! ê·¸ë¦¬ê³  ì´ **{book_info['page_count']}í˜ì´ì§€**ë‚˜ ë˜ë„¤ìš”. ëŒ€ë‹¨í•œ ì±…ì´ì—ìš”! ğŸ“š\n")
    else:
        st.write(book_info["error"])

    target_days_input = st.text_input("\nëª©í‘œ ì½ê¸° ê¸°ê°„(ì¼)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:")
    if target_days_input:
        target_days = int(re.sub(r'\D', '', target_days_input))
        daily_pages, remaining_pages = calculate_daily_pages(int(book_info["page_count"]), target_days)

        st.write(f"í•˜ë£¨ì— **{daily_pages}í˜ì´ì§€**ì”© ì½ìœ¼ë©´ ë”± ë§ì„ ê±°ì˜ˆìš”. (ë§ˆì§€ë§‰ ë‚ ì€ {remaining_pages}í˜ì´ì§€ê°€ ë‚¨ì„ì§€ë„ìš”!) ğŸ¦«")
        if remaining_pages > 0:
            st.write(f"ë§ˆì§€ë§‰ ë‚  ì¶”ê°€ë¡œ ì½ì–´ì•¼ í•  í˜ì´ì§€: **{remaining_pages}ìª½**")
        st.write("ì˜¤ëŠ˜ë¶€í„° ì‹œì‘í•´ë³¼ê¹Œìš”? ì œê°€ ì‘ì›í• ê²Œìš”, íœ˜ë¦¬ë¦­~! ğŸ’¨ğŸ¾")

        # ëª©í‘œ ê´€ë¦¬
        total_pages = int(book_info["page_count"])
        remaining_pages = total_pages
        remaining_days = target_days

        # ì½ê¸° ëª©í‘œ ê´€ë¦¬ (ì±…ì„ ë‹¤ ì½ì„ ë•Œê¹Œì§€ ë°˜ë³µ)
        while remaining_pages > 0 and remaining_days > 0:
            # key ê°’ì— ë™ì  ê°’ì„ ì‚¬ìš©í•˜ì—¬ ê³ ìœ í•˜ê²Œ ì„¤ì •
            pages_read_today = st.number_input(
                f"ì˜¤ëŠ˜ ì½ì€ í˜ì´ì§€ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ë‚¨ì€ í˜ì´ì§€: {remaining_pages}):", 
                min_value=0, 
                max_value=remaining_pages,
                key=f"pages_read_{remaining_pages}_{remaining_days}_{book_info['title']}"  # ê³ ìœ í•œ keyë¥¼ ì¶”ê°€
            )

            if pages_read_today:
                remaining_pages, new_daily_goal, remaining_days, status = recalculate_goal_dynamic(remaining_pages, pages_read_today, remaining_days)

                if remaining_pages == 0:
                    st.write("ìš°ì™€~! ğŸ¦¦ ì±…ì„ ë‹¤ ì½ì—ˆì–´ìš”! ëŠê¸‹í•œ ì¹´í”¼ë°”ë¼ë„ ë†€ëì–´ìš”! ğŸ‰")
                    save_goal(book_info['title'], target_days, daily_pages, remaining_pages)
                    give_challenge(book_info['title'])
                    break
                elif remaining_pages > 0:
                    st.write(f"ìš°ì›…~! ì˜¤ëŠ˜ {pages_read_today}í˜ì´ì§€ë¥¼ ì½ì—ˆë„¤ìš”! ì˜í–ˆì–´ìš”! ğŸ¦«")
                    st.write(f"ë‚¨ì€ í˜ì´ì§€ëŠ” {remaining_pages}í˜ì´ì§€ì—ìš”.")
                    st.write(f"ë‚´ì¼ë¶€í„°ëŠ” í•˜ë£¨ì— {new_daily_goal}í˜ì´ì§€ì”© ì½ìœ¼ë©´ ë¼ìš”!")
                    st.write(f"ë‚¨ì€ ëª©í‘œ ì¼ìˆ˜ëŠ” {remaining_days}ì¼ì´ì—ìš”. íŒŒì´íŒ…! ğŸ’ªğŸ“š")
    else:
        st.write("ëª©í‘œ ì½ê¸° ê¸°ê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!")

    # ì´ì „ ëª©í‘œ í™•ì¸í•˜ê¸°
    st.write("ğŸ“… ì§€ë‚œ ëª©í‘œ í™•ì¸í•˜ê¸°:")
    goals = load_goals()


